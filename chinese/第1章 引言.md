# 第一部分 基础准备

# 第1章 引言

欢迎阅读《**深入PostgreSQL内核：架构、设计与开发实践**》。本书旨在引领您深入探索世界上最先进的开源关系型数据库——**PostgreSQL**——的内部奥秘。这并非一本关于SQL语法或数据库管理的入门指南，而是一次穿越数据库核心引擎的旅程，专注于理解其架构、设计哲学以及如何进行二次开发和贡献。

## 1.1 本书适合哪些人

本书主要为以下读者编写：

*   **PostgreSQL内核开发者与贡献者**：无论您是希望为PostgreSQL社区提交补丁、修复Bug，还是开发新特性，本书将为您提供核心子系统的详细解读和开发实践指导。
*   **数据库研发工程师**：如果您需要基于PostgreSQL进行深度的定制化开发，例如修改优化器、添加新的存储引擎或访问方法、打造专属的分布式或异构数据库分支，本书将作为您理解底层机制的蓝图。
*   **高级数据库管理员（DBA）和性能优化专家**：对于那些不满足于参数调优，希望从原理层面彻底理解数据库行为（如锁竞争、事务隔离、WAL机制、Vacuum过程）以进行极致性能调优和复杂故障排查的专家，本书将提供不可或缺的深度视角。
*   **高校计算机相关专业的学生与研究人员**：本书是学习数据库系统实现原理的绝佳实践材料。通过剖析一个成熟工业级数据库的代码，可以将抽象的理论（如MVCC、B-Tree、查询优化）与具体的实现对应起来。

**阅读本书所需的预备知识**：
*   熟练掌握 **SQL** 语言和数据库基本概念。
*   **熟悉PostgreSQL数据库的主要功能和机制**，如有过使用、管理或应用开发经验为佳。
*   具备 **C语言** 的阅读和编写能力（这是PostgreSQL的实现语言）。
*   对操作系统（如进程、内存管理、文件系统）和数据结构的基本了解。
*   拥有强烈的好奇心和动手实践的热情。

## 1.2 核心方法论：代码是最精确的文档

在开始后续章节之前，我们需要确立本书的核心学习理念：

> **代码是最精确、最权威的文档。**

PostgreSQL 拥有庞大而复杂的代码库，任何书籍或文章都无法替代直接阅读源代码所带来的深刻理解。本书的目标不是成为一份面面俱到的代码说明书，而是作为您探索源码的 **"地图"和"导览"**。

因此，在讲解每一个核心机制时，本书都会：
*   **指明关键源码文件的位置**：例如，在介绍B-Tree索引时，我们会指出相关代码主要在 `src/backend/access/nbtree/` 目录下。
*   **解析核心数据结构的定义**：例如，会引导您查看 `src/include/nodes/plannodes.h` 中的 `Plan` 结构体。
*   **分析重要函数的流程**：例如，会详细讲解 `src/backend/executor/execMain.c` 中的 `ExecutorRun` 函数如何工作。

我们强烈建议您在阅读时，随时准备一个IDE或代码浏览工具（如配置了 `ctags`/`cscope` 的Vim/Emacs，或现代IDE如VSCode、CLion），**随时对照文中提及的代码路径进行查阅和跟踪**。这种"阅读-讲解-验证"相结合的方式，将是您掌握PostgreSQL内核开发最有效的方法。

## 1.3 如何使用本书

本书的章节安排遵循由浅入深、由宏观到微观的原则。

*   **顺序阅读**：建议初学者从头至尾按顺序阅读，这将帮助您系统地构建起PostgreSQL内核的知识体系。每一章都建立在之前章节的概念基础之上。
*   **专题查阅**：如果您对某个特定模块 already 有初步了解，可以直接跳转到相关章节进行深度研读。例如，专注于查询优化可以直接阅读SQL引擎部分的相应章节。
*   **动手实践**：本书绝非纯粹的理论读物。**"纸上得来终觉浅，绝知此事要躬行"**。我们强烈建议您：
    *   按照第2章的指引，亲手搭建一个带调试功能的编译环境。
    *   在阅读过程中，随时使用GDB等调试器跟踪代码执行流程，查看数据结构的变化。
    *   完成书中提供的"实践"示例，例如尝试编写一个简单的扩展或修改一小部分代码来观察行为变化。
*   **结合源码**：请将本书与PostgreSQL源码结合使用，这是我们最重要的方法论。

## 1.4 本书基于的版本

为了保证内容的准确性和时效性，本书的代码讲解和实例分析均基于 **PostgreSQL 14**。我们选择该版本是因为它是一个成熟的长期支持（LTS）版本，拥有良好的稳定性，且其核心架构在后续版本中保持了高度的一致性。

尽管版本之间存在细微差异，但PostgreSQL的核心机制（如进程架构、MVCC、WAL、优化器框架）是相对稳定的。因此，您通过学习本书建立起来的知识体系，对于理解更高版本的PostgreSQL（如15、16乃至17）依然具有极高的价值。我们会尽量指出哪些是版本无关的核心概念，哪些是版本特定的实现细节。

## 1.5 后续各章的组织结构

本书按照从基础到核心子系统，再到高级主题的顺序组织，共分为十三个主要部分：

### **第一部分：基础准备**
*   **第1章 引言**：介绍本书的读者对象、使用方法和组织结构。
*   **第2章 搭建开发环境**：指导如何获取源代码、编译安装、配置调试环境。

### **第二部分：进程框架**
*   **PG数据库架构**：整体架构概述，包括进程模型和内存结构。
*   **进程产生与后端进程初始化过程**：深入解析PostgreSQL的多进程模型和进程启动流程。
*   **信号机制**：讲解进程间通信和信号处理机制。

### **第三部分：SQL引擎**
*   **解析器--语法解析**：基于Bison的语法分析和移进归约过程。
*   **解析器--语义分析**：ParseTree的构建和语义分析。
*   **优化器--查询重写**：查询树的重写过程和规则应用。
*   **优化器--查询优化**：表达式、路径和计划的生成过程。
*   **执行器--Portal管理**：游标和预备语句的执行管理。
*   **执行器--算子**：各种执行算子的实现原理。
*   **执行器--Slot处理**：元组的读写、过滤、投影和发送。
*   **存储过程和函数**：存储过程、函数和匿名块的实现。
*   **内置函数**：系统内置函数的实现机制。
*   **数据类型系统**：操作符、操作符类和隐式转换的实现。
*   **分区表**：表分区的实现原理和机制。

### **第四部分：存储引擎**
*   **行存（页结构与元组结构）**：堆表的页面布局和元组结构。
*   **表的建立（包含临时表）**：表创建的物理过程和存储结构。
*   **Vacuum与autovacuum**：MVCC清理机制的原理和实现。
*   **PG段页式存储**：PostgreSQL的存储架构基础。

### **第五部分：索引**
*   **B-Tree、Hash、GiST、GIN索引**：各种索引类型的实现原理。
*   **索引访问方法接口**：索引AM的统一接口设计。
*   **实践：添加新的索引类型**：手把手指导如何扩展索引类型。

### **第六部分：事务机制**
*   **CLog**：事务提交日志的实现原理。
*   **事务提交与终止过程**：事务生命周期管理。
*   **锁管理**：自旋锁、轻量级锁和常规锁的实现。
*   **死锁处理**：死锁检测和解决机制。
*   **Isolation and MVCC**：隔离级别和多版本并发控制的实现。

### **第七部分：内存管理**
*   **共享内存框架**：进程间共享内存的管理。
*   **内存上下文**：层次化内存管理机制。
*   **BufferMgr**：缓冲区管理器的实现和页面置换算法。
*   **系统表缓存机制与InvalidMsg**：系统缓存的管理和失效机制。

### **第八部分：日志与恢复**
*   **日志的生成与写入**：WAL日志的生成和写入过程。
*   **日志归档与恢复原理**：日志归档和PITR的实现。
*   **日志回放/恢复**：崩溃恢复和日志重做过程。

### **第九部分：复制机制**
*   **流复制**：物理流复制的实现原理。
*   **逻辑复制**：逻辑复制的发布订阅模型和数据过滤。

### **第十部分：高可用性与灾难恢复**
*   **备节点提升机制**：故障切换和主备切换的实现。
*   **节点回归机制**：节点重新加入集群的流程。

### **第十一部分：插件与扩展开发**
*   **服务端编程接口（SPI）**：在C函数中执行SQL的接口。
*   **用户定义函数（UDF）与数据类型**：扩展函数和数据类型的开发。
*   **插件（Extension）系统**：扩展的打包、分发和管理。
*   **实践：编写完整的扩展**：从零开始开发一个完整扩展。

### **第十二部分：连接与外部数据**
*   **前端/后端协议**：客户端-服务器通信协议。
*   **外部数据包装器（FDW）**：FDW API的详细解析。
*   **实践：编写简单的FDW**：连接自定义数据源的实现。

### **第十三部分：调试、性能与社区**
*   **常用调试技巧**：GDB调试、日志输出和断言处理。
*   **性能分析工具**：查询性能分析和系统性能剖析。
*   **阅读提交日志**：理解社区开发讨论的方法。
*   **参与社区贡献**：补丁提交、代码评审和社区工作流程。

### **附录**
*   **重要数据结构详解**：核心数据结构的详细说明。
*   **常用工具与命令参考**：开发工具和命令的使用指南。
*   **推荐阅读与资源**：进一步学习的资料和资源。

现在，请准备好您的编辑器、终端和调试器，让我们一同开启这段深入PostgreSQL内核的精彩旅程吧！